# Kustomization for `latest` environment
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# resources:
  # - ../../../apps
  # - ../../../infrastructure
  # - vault-secrets-operator.yaml

# Add this to all resources
nameSuffix: -latest

labels:
- includeSelectors: true
  pairs:
    environment: latest

# Generate a re-usable environment variable for other resources
configMapGenerator:
  - name: flux-env
    literals:
      - fluxEnv="latest"

    # This config resource is not added to the cluster
    options:
      annotations:
        config.kubernetes.io/local-config: "true"

# Teach kustomize how to update generated names
configurations:
  - kustomizeconfig.yaml

patches:

  # Update oci repository ref selection to target latest chart images
  - target:
      kind: OCIRepository
      annotationSelector: "config.fluxcd.io/workload-type=app"
    patch: |-
      - op: replace
        path: /spec/ref
        value: {"tag": "latest"}

  # Patches Fluxcd "GitLab Webhook" ingress to facilitate reconciliation
  - target:
      kind: Ingress
      annotationSelector: "app=flux"
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: flux.latest.ltc.bcit.ca
      - op: replace
        path: /spec/tls/0/hosts/0
        value: flux.latest.ltc.bcit.ca

  # Add the environment label to all resources in the Helm chart
  - target:
      kind: HelmRelease
    patch: |-
      - op: add
        path: /spec/postRenderers
        value:
          - kustomize:
              patches:
                - target:
                    kind: .*
                  patch: |
                    apiVersion: v1
                    kind: ConfigMap   # placeholder; not used
                    metadata:
                      name: placeholder
                      labels:
                        environment: latest

  # Patch resources with environment-specific values
  - target:
      kind: VaultAuthGlobal
    patch: |-
      - op: replace
        path: /spec/kubernetes/mount
        value: kubernetes-latest
      - op: replace
        path: /spec/kubernetes/audiences
        value: [latest]

  # Remove all stable resources (this env should only emit latest resources)
  #   - delete patch taken from https://github.com/kubernetes-sigs/kustomize/issues/1593
  - target:
      name: ingress-stable
    patch: |
      $patch: delete
      kind: Ingress
      metadata:
        name: DOES NOT MATTER

  - target:
      name: star-ltc-bcit-ca
    patch: |
      $patch: delete
      kind: VaultStaticSecret
      metadata:
        name: DOES NOT MATTER

  # Remove all stable resources
  #   - delete patch taken from https://github.com/kubernetes-sigs/kustomize/issues/1593
  #
  - target:
      kind: Ingress
    patch: |
      - op: replace
        path: /spec/tls/0/secretName
        value: star-latest-ltc-bcit-ca

replacements:
  - source:
      kind: ConfigMap
      name: flux-env
      fieldPath: data.fluxEnv
    targets:

      # Replace the secrets's environment placeholder with the correct path
      # - path should match {appName}/{environment}/{secretName}
      - select:
          kind: VaultStaticSecret
        fieldPaths:
          - spec.path
        options:
          delimiter: "/"
          index: 1
        reject:
          - name: star-latest-ltc-bcit-ca
          - name: vault-manager-secret
          - name: github-webhook-token
          - name: github-private-repo-token
          - name: gh-private-oci-token
          - name: tailscale-oauth

      # Add the environment as a suffix to the default connection
      - select:
          kind: VaultAuthGlobal
        fieldPaths:
          - spec.vaultConnectionRef
        options:
          delimiter: "-"
          index: 99

      # Add the environment as a suffix to the global auth name
      - select:
          kind: VaultAuth
        fieldPaths:
          - spec.vaultAuthGlobalRef.name
        options:
          delimiter: "-"
          index: 99

      # Add the environment as a suffix to the postgres auth name
      - select:
          kind: VaultAuth
          name: postgres-vault-auth
        fieldPaths:
          - spec.kubernetes.serviceAccount
        options:
          delimiter: "-"
          index: 99

      # Add the environment as a suffix to the postgres database
      - select:
          kind: Database
        fieldPaths:
          - spec.cluster.name
        options:
          delimiter: "-"
          index: 99

      # Add the environment to VaultDynamicSecrets configs
      - select:
          kind: VaultDynamicSecret
          name: db-credentials
        fieldPaths:
          - spec.mount
          - spec.path
          # - metadata.annotations.app/db-host
        options:
          delimiter: "-"
          index: 2

      # Replace the placeholder environment in the postgres GRANT_PRIVILEGES job
      - select:
          kind: Job
        fieldPaths:
          - spec.template.spec.containers.0.env.[name=PGHOST].value
          - spec.template.spec.containers.0.env.[name=PGUSER].valueFrom.secretKeyRef.name
          - spec.template.spec.containers.0.env.[name=PGPASSWORD].valueFrom.secretKeyRef.name
        options:
          delimiter: "-"
          index: 2

      # Replace the placeholder environment in the postgres INIT_DB job configMap name
      - select:
          kind: Job
        fieldPaths:
          - spec.template.spec.volumes.[name=sql].configMap.name
        options:
          delimiter: "-"
          index: 99

      # Add the environment as a prefix to the ingress host
      - select:
          kind: Ingress
        fieldPaths:
          - spec.rules.0.host
          - spec.tls.0.hosts.0
        options:
          delimiter: "."
          index: 1

      # Update Tailscale's secret path
      # - path should match {appName}/{environment}/{secretName}
      - select:
          kind: VaultAuth
          name: tailscale-operator-vault-auth
        fieldPaths:
          - spec.kubernetes.role
        options:
          delimiter: "-"
          index: 99